{{- if .Values.dapr.enabled }}
---
# Task events subscription for recurring-tasks service
apiVersion: dapr.io/v2alpha1
kind: Subscription
metadata:
  name: task-events-subscription
  namespace: {{ .Release.Namespace }}
spec:
  topic: task-events
  routes:
    default: /events/task-completed
  pubsubname: kafka-pubsub
  scopes:
    - recurring-tasks
  bulkSubscribe:
    enabled: true
    maxMessagesCount: 100
    maxAwaitDurationMs: 1000
  deadLetterTopic: task-events-dlq

---
# Task events subscription for audit service
apiVersion: dapr.io/v2alpha1
kind: Subscription
metadata:
  name: task-events-audit-subscription
  namespace: {{ .Release.Namespace }}
spec:
  topic: task-events
  routes:
    default: /events/task-event
  pubsubname: kafka-pubsub
  scopes:
    - audit
  bulkSubscribe:
    enabled: true
    maxMessagesCount: 100
    maxAwaitDurationMs: 1000
  deadLetterTopic: task-events-audit-dlq

---
# Reminders subscription for notifications service
apiVersion: dapr.io/v2alpha1
kind: Subscription
metadata:
  name: reminders-subscription
  namespace: {{ .Release.Namespace }}
spec:
  topic: reminders
  routes:
    default: /events/reminder
  pubsubname: kafka-pubsub
  scopes:
    - notifications
  bulkSubscribe:
    enabled: false
  deadLetterTopic: reminders-dlq

---
# Task updates subscription for frontend notifications
apiVersion: dapr.io/v2alpha1
kind: Subscription
metadata:
  name: task-updates-subscription
  namespace: {{ .Release.Namespace }}
spec:
  topic: task-updates
  routes:
    default: /events/task-update
  pubsubname: kafka-pubsub
  scopes:
    - frontend
  bulkSubscribe:
    enabled: true
    maxMessagesCount: 50
    maxAwaitDurationMs: 500
  deadLetterTopic: task-updates-dlq
{{- end }}
