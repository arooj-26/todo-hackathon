# Database Migrations with Alembic

This directory contains database migration scripts managed by Alembic.

## Setup

Alembic is already configured in this project. The configuration is in:
- `alembic.ini` - Main configuration file
- `migrations/alembic/env.py` - Environment configuration
- `migrations/alembic/versions/` - Migration version scripts

## Environment Variables

Set the `DATABASE_URL` environment variable to override the database URL in `alembic.ini`:

```bash
export DATABASE_URL="postgresql://postgres:postgres@localhost:5432/todo_chatbot"
```

## Common Commands

### Generate a new migration (autogenerate)

```bash
cd phase-5/services/chat-api
alembic revision --autogenerate -m "Description of changes"
```

This will:
1. Compare the current database schema with your SQLModel models
2. Generate a new migration script in `migrations/alembic/versions/`
3. Include detected schema changes (new tables, columns, indexes, etc.)

### Apply migrations (upgrade to latest)

```bash
cd phase-5/services/chat-api
alembic upgrade head
```

### Rollback the last migration

```bash
cd phase-5/services/chat-api
alembic downgrade -1
```

### View current migration status

```bash
cd phase-5/services/chat-api
alembic current
```

### View migration history

```bash
cd phase-5/services/chat-api
alembic history
```

## Migration Workflow

### 1. Initial Setup (First Time)

```bash
# Generate initial migration from existing models
cd phase-5/services/chat-api
alembic revision --autogenerate -m "Initial schema"

# Apply the migration
alembic upgrade head
```

### 2. Making Schema Changes

When you modify your models (add/remove fields, tables, etc.):

```bash
# 1. Edit your SQLModel models in src/models/
# 2. Generate migration for your changes
alembic revision --autogenerate -m "Add column xyz to users"

# 3. Review the generated migration file in migrations/alembic/versions/
# 4. Apply the migration
alembic upgrade head
```

### 3. Production Deployment

```bash
# Always backup database before applying migrations in production
# Apply migrations as part of deployment
alembic upgrade head
```

## Best Practices

1. **Always review autogenerated migrations** before applying them
2. **Test migrations on a development database** first
3. **Backup production database** before running migrations
4. **Include both upgrade() and downgrade()** functions in migration scripts
5. **Keep migrations small and atomic** - one logical change per migration
6. **Never edit applied migrations** - create a new migration to fix issues
7. **Commit migration files** to version control

## Troubleshooting

### "Target database is not up to date"

```bash
# Check current version
alembic current

# Stamp database with current version (if migrations are out of sync)
alembic stamp head
```

### "Can't locate revision identified by 'xyz'"

```bash
# This means the database has a migration that doesn't exist in your code
# Option 1: Restore missing migration files from git
# Option 2: Stamp database with an existing revision
alembic stamp <existing_revision_id>
```

### Start fresh (development only - will delete all data)

```bash
# Drop all tables
psql -d todo_chatbot -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"

# Re-run migrations from scratch
alembic upgrade head
```

## File Naming Convention

Migration files are named with this format:
```
YYYYMMDD_HHMM_<revision_id>_<slug>.py
```

Example:
```
20260113_1430_abc123def456_add_user_timezone.py
```

## Important Notes

- **Never modify applied migrations** in production - create a new migration instead
- **Always test rollback** (downgrade) functions before deploying
- **Keep DATABASE_URL synchronized** between application and Alembic
- **Use transactions** for complex migrations to ensure atomicity
